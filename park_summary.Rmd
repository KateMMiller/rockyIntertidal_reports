---
output:
  html_document:
    css: www/styles.css
    anchor_sections: FALSE
    includes:
      in_header: "header_manual.html"

params:
  year_curr: 2021
  park: "ACAD"
  all_years: TRUE # If FALSE, only reports on year_curr; TRUE reports on all years; Not enabled yet
---

```{r setup, include = F}
knitr::opts_chunk$set(echo = FALSE)
options(knitr.kable.NA = '', scipen = 100)
#knitr::opts_chunk$set(fig.width=12, fig.height=10) 
```

```{r imports, include = FALSE}
library(rockyIntertidal)
library(tidyverse)
library(grid)
library(knitr)
```

```{r imports2, include = FALSE, cache = T}
importData()
path = "../data/rocky/temp_data/Compiled_HT_water_temps/"
importWaterTemp(path = path, simplify = T, buoy = T)
```

```{r params, include = FALSE}
# park = "BOHA"
# year_curr = 2021
# years = 2013:2021

run = TRUE # using for testing, so don't have to wait forever for full report to knit, when
# just testing 1 section. run = FALSE only runs the chunks set to eval = TRUE; 

park = params$park
year_curr = params$year_curr
years = if(params$all_years == TRUE){2013:year_curr} else {year_curr}

# Set up args list
arglist <- list(park = park, years = years)

locs <- do.call(getPIBoltDistance, arglist) |>
  select(Loc_Code) |> arrange(Loc_Code) |> unique() |> c() #|> as.character()

trans_species <- do.call(getPISpecies, arglist) |> 
  select(Spp_Code) |> arrange(Spp_Code) |> unique() |> 
  filter(!Spp_Code %in% c("BOLT", "ROCK", "WATER", NA, "OTHSUB", "OTHINV", "UNIDEN")) |> 
  c()

trans_species_com <- switch(park, 
                            "ACAD" = c("ALGGRE", "ALGRED", "ARTCOR", "ASCEPI", "ASCNOD", "BARSPP", 
                                      "CHOMAS", "CRUCOR", "FUCEPI", "FUCSPP", "MUSSPP", "ULVLAC"),
                            "BOHA" = c("ALGGRE", "ALGRED", "ASCEPI", "ASCNOD", "BARSPP", 
                                       "CHOMAS", "FUCEPI", "FUCSPP", "ULVLAC")
                       )

```

Rocky intertidal data summary for `r params$park` and `r paste(years, collapse = ", ")` {.tabset .tabset-pills}
---

```{r, warning = FALSE, message = FALSE, results = 'hide', include = FALSE, eval = run}
#---- Plotting all species by elevation per location -----
trans_species_plots <- 
  purrr::map(locs$Loc_Code,
             ~plotPISpecies(location = ., xlab = "Year", ylab = "Elevation MLLW (m)", species = 'all',
                                    title = TRUE, facet = TRUE, years = years, rev_axis = F) +
    theme(legend.position = 'bottom',
          legend.text = element_text(size = 10),
          legend.key.size = unit(0.5, 'cm'),
          legend.key.width = unit(0.5, 'cm'),
          legend.key.height = unit(0.5, 'cm'),
          legend.title = element_blank()))
```
```{r, warning = FALSE, message = FALSE, results = 'hide', include = FALSE, eval = run}
#---- Plotting individual PI transect species across all locations -----
trans_species_plots_park <- 
  purrr::map(trans_species_com, 
             ~ plotPISpecies(park = park, location = 'all', xlab = 'Year', ylab = "Elevation MLLW (m)",
                                     species = ., title = FALSE, facet = TRUE, years = years, rev_axis = F))
```
```{r, warning = FALSE, message = FALSE, results = 'hide', include = FALSE, eval = run}
#---- Plotting main 5 species for PI transects with plotly -----
trans_spp_plotly <- plotPISpecies(park = park, years = years, title = F, xlab = NULL, #facet = F,
                      species = 'all', main_groups = T, rev_axis = F, plotly = T, ribbon = T)
```
```{r, warning = FALSE, message = FALSE, results = 'hide', include = FALSE, eval = run}
#---- Plotting photoplot cover by target species and site ----
photo_species_plots <- purrr::map(locs$Loc_Code,
  ~plotPhotoCover(location = ., species = 'all', top_spp = 3, years = years)                                
  )
```
```{r, warning = FALSE, message = FALSE, results = 'hide', include = FALSE, eval = run}
#---- Plotting individual photoplot target species across all locations
targ_spp <- switch(park, 
                   "ACAD" = c("Barnacle", "Fucus", "Ascophyllum", "Red Algae", "Mussel"),
                   "BOHA" = c("Barnacle", "Fucus", "Ascophyllum", "Red Algae"))
                   
```
```{r, warning = FALSE, message = FALSE, results = 'hide', include = FALSE, eval = run}
photo_species_plots_park <- purrr::map(targ_spp,
  ~plotPhotoCover(park = park, location = 'all', target_species = ., 
                  top_spp = 3, species = 'all', years = years)                                
  )

```
```{r, warning = FALSE, message = FALSE, results = 'hide', include = FALSE, eval = run}
photo_species_heatmap <- purrr::map(locs$Loc_Code,
  ~plotPhotoCover(park = park, location = ., heatmap = TRUE, main_groups = T, years = years))

```

```{r, contour_chunk, warning = FALSE, message = FALSE, eval = FALSE}
plotSpeciesContours(location = loc, years = years, plot_title = F)
```

```{r contour, eval =  FALSE}
knitr::include_graphics(paste0("C:/NETN/R_Dev/rockyIntertidal_reports/imgs/", loc, "_contour_2013_2021.svg"))

```

### Site Contours {.tabset}
```{r warning = FALSE, message = FALSE, results = 'asis', eval = TRUE, fig.height = 9, out.width = "160%"}
for(i in seq_along(locs$Loc_Code)){
  loc <- locs$Loc_Code[[i]]
  cat("#### ", loc, "\n\n")
  cat("Smoothed site contours based on bolt elevation and transect distances averaged over all years. Species lines along contours represent the minimum and maximum ranges observed for each of the 5 main species across the three point intercept transects per year. Pie charts represent the median percent cover by species and median e levation across photoplots for each year. The five main species are: BARSPP, MUSSPP, ASCNOD, FUCSPP, and combined Red algae group.\n")
  cat("\n\n")
  <<contour_chunk>>
  cat("\n\n")
  cat("\n\n")

}
```

### Point Intercept Transects {.tabset}

#### By Main Species {.tabset}
Point Intercept species by elevation across locations. Points are median elevation across 3 transects. 
Bands lower 25% and upper 75% distributions across 3 transects for the primary species of concern. In the legend, Ascophyllum nodosum (Knotted wrack) is abbreviated as ASCNOD, Barnacles are abbreviated as BARSPP, Fucus spp. (Rockweed) is abbreviated as FUCSPP, Mussels are abbreviated as MUSSPP, and red algae are abbreviated as REDGRP. The red algae group includes Irish moss (Chondrus / Mastocarpus) and algae identified as Other Algae - Red. 
```{r fig.height = 8, fig.width = 10, eval = run}
trans_spp_plotly
```

#### By Location {.tabset}
```{r warning = FALSE, message = FALSE, fig.height = 8, fig.width = 10, results = 'asis', eval = run}
for(i in seq_along(locs$Loc_Code)){
  loc <- locs$Loc_Code[[i]]
  cat("##### ", loc, "\n")
  cat("Point Intercept species by elevation. Points are median elevation across 3 transects. 
       Wider lines are the middle 25% and 75% quantiles. Thin lines are minimum and maximum elevations 
       recorded for a given species.", "\n")
  print(trans_species_plots[[i]])
  cat("\n\n") 
}
```

#### By Species {.tabset}
```{r warning = FALSE, message = FALSE, fig.height = 8, fig.width = 10, results = 'asis', eval = run}
for(i in seq_along(trans_species_com)){
  cat("##### ", trans_species_com[[i]], "\n")
  cat("Point Intercept species by elevation across locations. Points are median elevation across 3 transects.
      Wilder lines are the middle 25% and 75% quantiles. Thin lines are minimum and maximum elevations
      recorded for a given species.", "\n")
  print(trans_species_plots_park[[i]])
  cat("\n\n")
}
```

### Photoplots {.tabset}

#### By Location {.tabset}
```{r warning = FALSE, message = FALSE, fig.height = 8, fig.width = 10, results = 'asis', eval = run}
for(i in seq_along(locs$Loc_Code)){
  cat("##### ", locs$Loc_Code[[i]], "\n")
  cat("Species percent cover by target species group. Points are median cover across photoplots. 
       Error bars are minimum and maximum cover recorded within a target species. Only top 3 species
       are plotted in each target species group, with tied species included.", "\n")
  print(photo_species_plots[[i]])
  cat("\n\n") 
}
```

#### By Target Species {.tabset}
```{r warning = FALSE, message = FALSE, fig.height = 8, fig.width = 10, results = 'asis', eval = run}
for(i in seq_along(targ_spp)){
  cat("##### ", targ_spp[[i]], "\n")
  cat("Species percent cover by target species group across all lcoations. Points are median cover across photoplots. 
       Error bars are minimum and maximum cover recorded within a target species. Only top 3 species
       are plotted in each target species group, with tied species included.", "\n")
  print(photo_species_plots_park[[i]])
  cat("\n\n") 
}
```

#### Heatmaps {.tabset}
```{r warning = FALSE, message = FALSE, fig.height = 8, fig.width = 12, results = 'asis', eval = run}
for(i in seq_along(locs$Loc_Code)){
  cat("##### ", locs$Loc_Code[[i]], "\n")
  cat("Median percent cover by target species group for main 5 species per photoplot target species. ", "\n")
  print(photo_species_heatmap[[i]])
  cat("\n\n") 
}
```


### Temperature Loggers {.tabset}
#### By Location {.tabset}
```{r loc_buoy, echo = F, eval = F, out.width = "100%", out.height = "60%", eval = run}
suppressWarnings(plotBuoyData(park = park, years = years, metric = 'all', facet_col = 1))
```

```{r loc_water, echo = F, eval = F, out.width = "100%", out.height = "40%", eval = run}
suppressWarnings(print(plotWaterTemp(park = park, location = loc, legend_position = 'none',
                                     years = years, facet = F, plotly = F, palette = 'greyscale')))
```

```{r warning = FALSE, message = FALSE, results = 'asis', eval = run}
for(i in seq_along(locs$Loc_Code)){
  loc = locs$Loc_Code[[i]]
  cat("##### ", loc, "\n\n")
  cat("Daily buoy statistics for ", park, ". Wind direction is the value recorded during the daily maximum wind speed. ", "\n\n", sep = "")
  <<loc_buoy>>
  cat("\n\n")
  cat("High tide water temperature (F) for ", loc, "\n\n")
  <<loc_water>>
  cat("\n\n")
} 
```

#### By Year {.tabset}
```{r year_buoy, echo = F, eval = F, out.width = "100%", eval = FALSE}
suppressWarnings(plotBuoyData(park = park, years = year, metric = 'all', facet_col = 1))
```

```{r year_water, echo = F, eval = F, out.width = "100%", eval = FALSE}
suppressWarnings(print(plotWaterTemp(park = park, location = loc, legend_position = "none",
                                     years = year, facet = F, plotly = F, palette = "greyscale")))
```

```{r results = 'asis', eval = run}
for(i in seq_along(years)){
  year = years[[i]]
  cat("##### ", year, "\n\n")
  cat("Daily buoy statistics for ", year, ". Wind direction is the value recorded during the daily maximum wind speed. ", "\n\n", sep = "")
  <<year_buoy>>
    cat("\n\n")
  cat("High tide water temperature (F) for ", year, " by site.", "\n\n")
    for(j in seq_along(locs$Loc_Code)){
      loc = locs$Loc_Code[[j]]
      cat("<details open><summary class = 'drop'>", loc, "</summary>")
      <<year_water>>
        cat("\n\n")
      cat("</details>", "\n\n")
    } 
  cat("\n\n")
} 
```

